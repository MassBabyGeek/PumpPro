import React, {useState, useEffect} from 'react';
import 'react-native-gesture-handler';
import {NavigationContainer} from '@react-navigation/native';
import {createStackNavigator} from '@react-navigation/stack';
import {SafeAreaProvider} from 'react-native-safe-area-context';
import AsyncStorage from '@react-native-async-storage/async-storage';
import Toast from 'react-native-toast-message';
import {AuthProvider} from './src/contexts/AuthContext';
import {OfflineProvider} from './src/contexts/OfflineContext';
import {CalibrationProvider} from './src/contexts/CalibrationContext';
import {useAuth} from './src/hooks/useAuth';
import AuthStack from './src/components/Stacks/AuthStack/AuthStack';
import AppStack from './src/components/Stacks/AppStack/AppStack';
import OfflineBanner from './src/components/OfflineBanner';
import {toastConfig} from './src/components/CustomToast/CustomToast';
import ErrorBoundary from './src/components/ErrorBoundary';
import OnboardingScreen, {
  ONBOARDING_KEY,
} from './src/screens/OnboardingScreen/OnboardingScreen';
import WelcomeScreen from './src/screens/WelcomeScreen/WelcomeScreen';
import FirstChallengeScreen from './src/screens/FirstChallengeScreen/FirstChallengeScreen';

const RootStack = createStackNavigator();

const AppNavigator = () => {
  const {isAuthenticated} = useAuth();
  const [hasSeenOnboarding, setHasSeenOnboarding] = useState<boolean | null>(
    null,
  );

  useEffect(() => {
    checkOnboardingStatus();
  }, []);

  const checkOnboardingStatus = async () => {
    try {
      const value = await AsyncStorage.getItem(ONBOARDING_KEY);
      setHasSeenOnboarding(false);
    } catch (error) {
      console.error('Error checking onboarding status:', error);
      setHasSeenOnboarding(false);
    }
  };

  return (
    <>
      <OfflineBanner />
      <NavigationContainer>
        <RootStack.Navigator screenOptions={{headerShown: false}}>
          {isAuthenticated ? (
            <RootStack.Screen name="App" component={AppStack} />
          ) : hasSeenOnboarding ? (
            <RootStack.Screen name="Auth" component={AuthStack} />
          ) : (
            <>
              <RootStack.Screen name="Welcome" component={WelcomeScreen} />
              <RootStack.Screen
                name="Onboarding"
                component={OnboardingScreen}
              />
              <RootStack.Screen name="Auth" component={AuthStack} />
              <RootStack.Screen
                name="FirstChallenge"
                component={FirstChallengeScreen}
              />
            </>
          )}
        </RootStack.Navigator>
      </NavigationContainer>
    </>
  );
};

export default function App() {
  return (
    <SafeAreaProvider>
      <ErrorBoundary>
        <AuthProvider>
          <CalibrationProvider>
            <OfflineProvider>
              <AppNavigator />
              <Toast config={toastConfig} />
            </OfflineProvider>
          </CalibrationProvider>
        </AuthProvider>
      </ErrorBoundary>
    </SafeAreaProvider>
  );
}
